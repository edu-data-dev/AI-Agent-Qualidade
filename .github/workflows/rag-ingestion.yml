name: ğŸ§  CÃ©rebro de QA - Aprendizado ContÃ­nuo

on:
  push:
    branches: [main]
    paths:
      - 'data/**.py'
      - 'data/**.md'
      - 'src/**.py'
  pull_request:
    branches: [main]
    paths:
      - 'data/**.py'
      - 'data/**.md'
      - 'src/**.py'

jobs:
  rag-ingestion:
    name: ğŸ“š Atualizar Base de Conhecimento
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # NecessÃ¡rio para git diff
      
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Verificar se Ã© primeira execuÃ§Ã£o
        id: check-db
        run: |
          if [ ! -d "chroma_db" ] || [ -z "$(ls -A chroma_db 2>/dev/null)" ]; then
            echo "is_first_run=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• Primeira execuÃ§Ã£o detectada - serÃ¡ feito BOOTSTRAP completo"
          else
            echo "is_first_run=false" >> $GITHUB_OUTPUT
            echo "â™»ï¸  Banco existente detectado - serÃ¡ feita ingestÃ£o DELTA"
          fi
      
      - name: ğŸš€ Bootstrap inicial (primeira execuÃ§Ã£o)
        if: steps.check-db.outputs.is_first_run == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ¯ EXECUTANDO BOOTSTRAP - Processando TODO o projeto..."
          echo "ğŸ“‚ Isso pode levar alguns minutos dependendo do tamanho do projeto"
          python bootstrap_project.py --project-path . --include-config
          echo "âœ… Bootstrap concluÃ­do!"
      
      - name: ğŸ” Detectar arquivos alterados (execuÃ§Ãµes subsequentes)
        if: steps.check-db.outputs.is_first_run == 'false'
        id: changed-files
        run: |
          echo "Detectando arquivos alterados..."
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.(py|md)$' || echo "")
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Nenhum arquivo Python ou Markdown foi alterado"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Arquivos alterados detectados:"
            echo "$CHANGED_FILES"
          fi
      
      - name: ğŸ§  Executar ingestÃ£o delta (execuÃ§Ãµes subsequentes)
        if: steps.check-db.outputs.is_first_run == 'false' && steps.changed-files.outputs.has_changes == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸš€ Iniciando ingestÃ£o delta (apenas arquivos alterados)..."
          python src/main.py --delta
          echo "âœ… IngestÃ£o delta concluÃ­da!"
      
      - name: ğŸ“Š Validar banco de dados
        if: steps.check-db.outputs.is_first_run == 'true' || steps.changed-files.outputs.has_changes == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ” Validando banco de dados vetorial..."
          python validate_ingestion.py || echo "âš ï¸ ValidaÃ§Ã£o falhou, mas continuando..."
      
      - name: ğŸ’¾ Fazer upload do ChromaDB atualizado
        if: steps.check-db.outputs.is_first_run == 'true' || steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: chroma-db-${{ github.sha }}
          path: chroma_db/
          retention-days: 30
      
      - name: ğŸ“ Comentar no PR (se aplicÃ¡vel)
        if: github.event_name == 'pull_request' && (steps.check-db.outputs.is_first_run == 'true' || steps.changed-files.outputs.has_changes == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const isFirstRun = '${{ steps.check-db.outputs.is_first_run }}' === 'true';
            
            let comment = '';
            
            if (isFirstRun) {
              comment = `## ğŸ§  CÃ©rebro de QA - Bootstrap Inicial
              
              ### ğŸ‰ Base de conhecimento criada pela primeira vez!
              
              **Tipo de ingestÃ£o:** BOOTSTRAP COMPLETO
              
              **O que foi processado:**
              - Todo o cÃ³digo-fonte do projeto (.py, .java, .js, etc.)
              - Toda a documentaÃ§Ã£o (.md, .txt, etc.)
              - Arquivos de configuraÃ§Ã£o (.json, .yaml, etc.)
              
              **PrÃ³ximos passos:**
              - âœ… Banco de dados vetorial criado do zero
              - âœ… Todas as regras de negÃ³cio foram indexadas
              - âœ… O agente estÃ¡ pronto para gerar testes
              - ğŸ”„ PrÃ³ximas atualizaÃ§Ãµes serÃ£o INCREMENTAIS (apenas mudanÃ§as)
              
              **Artefato gerado:** \`chroma-db-${{ github.sha }}\`
              `;
            } else {
              const changedFiles = `${{ steps.changed-files.outputs.changed_files }}`.split('\n').filter(f => f);
              comment = `## ğŸ§  CÃ©rebro de QA - AtualizaÃ§Ã£o Incremental
              
              ### âœ… Base de conhecimento atualizada com sucesso!
              
              **Tipo de ingestÃ£o:** DELTA (apenas mudanÃ§as)
              
              **Arquivos processados:**
              ${changedFiles.map(f => `- \`${f}\``).join('\n')}
              
              **PrÃ³ximos passos:**
              - O banco de dados vetorial foi atualizado
              - Novas regras de negÃ³cio foram indexadas
              - O agente estÃ¡ pronto para gerar testes com o novo conhecimento
              
              **Artefato gerado:** \`chroma-db-${{ github.sha }}\`
              `;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ğŸ“Š Gerar relatÃ³rio de mudanÃ§as
        if: steps.check-db.outputs.is_first_run == 'true' || steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "# ğŸ“Š RelatÃ³rio de AtualizaÃ§Ã£o - CÃ©rebro de QA" > report.md
          echo "" >> report.md
          echo "**Data:** $(date)" >> report.md
          echo "**Commit:** ${{ github.sha }}" >> report.md
          echo "**Branch:** ${{ github.ref_name }}" >> report.md
          echo "" >> report.md
          
          if [ "${{ steps.check-db.outputs.is_first_run }}" == "true" ]; then
            echo "**Tipo:** BOOTSTRAP INICIAL (primeira execuÃ§Ã£o)" >> report.md
            echo "" >> report.md
            echo "## Processamento Completo" >> report.md
            echo "Todo o projeto foi analisado e indexado pela primeira vez." >> report.md
          else
            echo "**Tipo:** INGESTÃƒO DELTA (incremental)" >> report.md
            echo "" >> report.md
            echo "## Arquivos Alterados" >> report.md
            echo "${{ steps.changed-files.outputs.changed_files }}" | while read file; do
              [ -n "$file" ] && echo "- $file" >> report.md
            done
          fi
          
          echo "" >> report.md
          echo "## EstatÃ­sticas do Banco" >> report.md
          echo "_(Executar validate_ingestion.py para detalhes)_" >> report.md
          
          cat report.md
      
      - name: ğŸ“¤ Upload do relatÃ³rio
        if: steps.check-db.outputs.is_first_run == 'true' || steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ingestion-report-${{ github.sha }}
          path: report.md
          retention-days: 90

  notify-success:
    name: ğŸ‰ Notificar Sucesso
    runs-on: ubuntu-latest
    needs: rag-ingestion
    if: success()
    
    steps:
      - name: ğŸŠ Celebrar atualizaÃ§Ã£o
        run: |
          echo "ğŸ‰ ================================================"
          echo "ğŸ‰  CÃ‰REBRO DE QA ATUALIZADO COM SUCESSO!"
          echo "ğŸ‰ ================================================"
          echo ""
          echo "âœ… O agente estÃ¡ mais inteligente agora!"
          echo "âœ… Novas regras de negÃ³cio foram aprendidas"
          echo "âœ… Pronto para gerar testes mais precisos"
          echo ""
          echo "ğŸš€ PrÃ³xima geraÃ§Ã£o de testes serÃ¡ ainda melhor!"
